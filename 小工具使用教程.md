## 小工具使用教程

小工具的出现，是为了解决上传文件到对象存储的问题，小工具会在上传时自动计算出最小的上传操作（增量上传），提高效率，节省时间。

在上传时，建议全程使用小工具上传，而不是手动在后台一个一个文件上传，小工具会在每次上传之前自动生成校验文件，这一步很重要！而手动在后台一个一个文件上传**很容易**造成校验文件和实际内容对不上，导致更新出错！（使用手动上传模式则没有此限制）

**目前支持以下服务商的一键上传功能**：

阿里云对象存储（推荐）、腾讯云对象存储（推荐）、FTP/SFTP

!> 注意：无论使用什么方式上传，建议在上传之前**备份所有**现有的文件，以防文件丢失！

### 小工具使用方法

1. 编辑配置文件`config.yml`，参考下方的[配置说明](#小工具配置文件)，然后保存关闭
3. 运行`上传.bat`，开始上传
4. 上传完成后，直接关掉窗口就可以

### 小工具配置文件

#### 腾讯云

>   在配置前，建议提前备份桶内的**所有的文件**！也不要忘记将桶的权限设置为**公有读私有写**，否则无法是访问的！

这里以腾讯云为例，只需要修改下面列出的部分，其它部分请保持默认，不要给删掉了

```yaml
# 填写tencent表示要上传到腾讯云
service_provider: tencent

# 然后需要填写tencent部分，使用腾讯云的话，aliyun和ftp部分可以留空
tencent:
  bucket: update-system      # 桶名
  secret_id: abcdefg         # 访问秘钥的id
  secret_key: a1b2c3d4e5f6g7 # 访问秘钥的key
  region: ap-nanjing         # 桶的地域
```

#### 阿里云

>  在配置前，建议提前备份桶内的**所有的文件**！也不要忘记将桶的权限设置为**公共读**，否则无法是访问的！

这里以阿里云为例，只需要修改下面列出的部分，其它部分请保持默认，不要给删掉了

```yaml
# 填写aliyun表示要上传到阿里云
service_provider: aliyun

# 然后需要填写aliyun部分，使用阿里云的话，tencent和ftp部分可以留空
aliyun:
  bucket: update-system                # 桶名
  access_id: abcdefg                   # 访问秘钥的id
  access_key: a1b2c3d4e5f6g7           # 访问秘钥的key
  region: oss-cn-chengdu.aliyuncs.com  # 桶的地域
```

#### FTP

> 在配置前，建议提前备份FTP内**所有的文件**！

这里以FTP为例，只需要修改下面列出的部分，其它部分请保持默认，不要给删掉了

```yaml
# 填写ftp表示要上传到ftp
service_provider: ftp

# 然后需要填写ftp部分，使用ftp的话，aliyun和tencent部分可以留空
ftp:
  host: 127.0.0.1 # 主机地址
  port: 21        # 端口（通常是21）
  user: ab        # 用户名
  password: ab    # 密码
  base_path: /    # 上传到哪个路径，支持子目录，默认是根目录，必须以/开头，结尾不做要求
  secure: false   # 是否启用SFTP
```

因为一些原因，**SFTP模式下**无法校验服务端证书（请自行确保证书是可信的）

#### 完整配置示例


下面是一个完整的配置文件示例，仅供参考，不建议直接复制

<details>
<summary auto>点击</summary>

```yaml
# 是否在上传时显示调试数据
debug: false

# 是否跳过生成校验文件阶段，不要修改此选项！
# 如果调整为true则只会上传文件，不会重新生成校验文件
upload_only: false

# 上传完成后，是否不自动退出
# 设置为false后会直接退出，不会显示"任意键退出.."字样
show_any_key_to_exit: false

# 上传到哪里？
# 腾讯云请填写tencent
# 阿里云请填写aliyun
# FTP请填写ftp
service_provider: tencent

# 腾讯云需要填写此部分
tencent:
  # 桶名
  bucket: 
  # 访问秘钥的id
  secret_id: 
  # 访问秘钥的key
  secret_key: 
  # 桶的地域
  region: ap-nanjing
  
  # 缓存文件的文件名。用来实现增量上传
  # 此文件会存储到桶里（而不是本地），删除此文件可以进行一次全量上传
  # 只支持放置在桶的根目录（也就是说这里只能填写文件名不能填写一个路径）
  cache_file: .cache.yml

  # 按文件名自动添加http headers
  header_rules:
    # 正则表达式(按相对路径匹配，此路径不包含要上传的文件夹本身)
    - pattern: '.gz$'
    # 添加的http headers
      headers:
        Content-Encoding: gzip
  
# 阿里云需要填写此部分
aliyun:
  # 桶名
  bucket: 
  # 访问秘钥的id
  access_id: 
  # 访问秘钥的key
  access_key: 
  # 桶的地域
  region: oss-cn-chengdu.aliyuncs.com
  
  # 缓存文件的文件名。用来实现增量上传
  # 此文件会存储到桶里（而不是本地），删除此文件可以进行一次全量上传
  # 只支持放置在桶的根目录（也就是说这里只能填写文件名不能填写一个路径）
  cache_file: .cache.yml

  # 按文件名自动添加http headers
  header_rules:
    # 正则表达式(按相对路径匹配，此路径不包含要上传的文件夹本身)
    - pattern: '.gz$'
    # 添加的http headers
      headers:
        Content-Encoding: gzip

# FTP需要填写此部分
ftp:
  host: 127.0.0.1
  port: 21
  user: ab
  password: ab
  
  # 上传到哪个路径，支持子目录，默认是根目录，这里必须以/开头，结尾不做要求
  base_path: /
  
  # 缓存文件的文件名。用来实现增量上传
  # 此文件会存储到FTP服务器上（而不是本地），删除此文件可以进行一次全量上传
  # 只支持放置在根目录（也就是说这里只能填写文件名不能填写一个路径）
  cache_file: .cache.yml
  
  # 启用TLS加密（SFTP）
  secure: false
  
  # 高级参数，登录后是否立即发送prot_p命令
  prot_p: false
```

</details>

### 手动部署/手动上传（高级）

如果不想使用小工具的一键上传功能，可以仅把小工具当做`目录校验文件`生成器，并使用适合自己的方式手动上传到任意地方。每次上传之前，都需要重新生成或者说更新一下`目录校验文件`

目录校验文件是一个与目录同名的`.yml`结尾的文件，默认情况下通常是`res.yml`，放在其对应的目录旁边

#### 为什么要使用目录校验文件?

因为客户端完全依赖目录校验文件去计算自身与服务端的文件差异，如果文件夹内的文件有变动，就需要重新生成一次，否则客户端无法感知到服务端的文件修改

目录校验文件包含了目录里所有文件结构和信息（子目录结构、每个文件的校验和大小等）感兴趣可以亲自打开文件看一下结构。

#### 如何生成

生成校验文件可以使用小工具来生成（删除掉小工具的配置文件，只保留一个主程序，小工具就会进入**校验文件生成模式**，而不是上传模式）

具体操作方法是把`res`目录拖到小工具上松开，就会生成一个同名`.yml`文件，但建议写个批处理来进行操作，更加简单（如果使用批处理进行，那么可将要被生成的目录路径，作为参数传递给小工具，绝对路径和相对路径均可）

在生成好校验文件以后，请将校验文件和参与更新的文件一起上传到自己的服务器上

